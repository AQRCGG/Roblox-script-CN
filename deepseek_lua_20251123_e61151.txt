-- ç©å®¶è‡ªç„UIï¼ˆä¼˜åŒ–ç‰ˆ - é˜²é‡ç½® & æ–‡æœ¬æ¡†è¾“å…¥ï¼‰
-- Author: ç™½çš™uwu
-- ä¼˜åŒ–ç‰ˆï¼šé˜²æ­¢è§’è‰²é‡ç½®ã€åˆ—è¡¨å¼UIã€ç®€åŒ–éš”å¢™æ£€æµ‹ã€å‚æ•°æ— é™åˆ¶ã€æ–‡æœ¬æ¡†è¾“å…¥
-- è®¾ç½®å‚¨å­˜ä½ç½®ï¼šè‡ªå®šä¹‰ä½ç½®
--==================================================

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

-- ä½¿ç”¨å…¨å±€è¡¨ä¿å­˜è®¾ç½®ï¼Œé¿å…é‡ç½®
local Settings = {
    aimbotEnabled = false,
    wallCheckEnabled = false,
    rightClickEnabled = false,
    maxDistance = 100,
    fovRadius = 150,
    -- è‡ªç„é€Ÿåº¦å’ŒåŠ›åº¦è®¾ç½®
    aimSpeed = 15,
    aimStrength = 1.5,
    smoothAiming = true,
    -- ç›®æ ‡é€‰æ‹©è®¾ç½®
    targetPlayers = true,
    targetNPCs = false,
    -- å³é”®è‡ªç„æ¨¡å¼
    rightClickMode = "hold", -- "hold": æŒ‰ä½, "toggle": åˆ‡æ¢, "hybrid": æ··åˆæ¨¡å¼
    -- UIçŠ¶æ€
    uiVisible = true,
    uiMinimized = false,
    -- æ–°å¢ï¼šç©¿é€è®¾ç½®
    penetrateWalls = false, -- æ˜¯å¦ç©¿é€å¯ç©¿é€çš„å¢™
    penetrateGlass = true   -- æ˜¯å¦ç©¿é€ç»ç’ƒ
}

-- å…¨å±€å˜é‡å¼•ç”¨
local aimbotGUI = nil
local mainPanel = nil
local minimizeButton = nil
local Circle = nil

-- è‡ªç„ç›¸å…³å˜é‡
local rightClickAimbot = false
local rightClickToggled = false
local currentTarget = nil
local lastAimTime = 0
local lastRightClickTime = 0
local rightClickCooldown = 0.3 -- å³é”®å†·å´æ—¶é—´ï¼Œé¿å…å¿«é€Ÿåˆ‡æ¢

-- è‡ªå®šä¹‰è®¾ç½®å‚¨å­˜ä½ç½®
local SettingsManager = {
    -- é€‰æ‹©ä½ æƒ³è¦çš„å‚¨å­˜ä½ç½®ï¼š
    -- 1. "player_data" - ç©å®¶æ•°æ®æ–‡ä»¶å¤¹
    -- 2. "workspace" - å·¥ä½œåŒº
    -- 3. "lighting" - å…‰ç…§
    -- 4. "replicated_storage" - å¤åˆ¶å‚¨å­˜
    -- 5. "server_storage" - æœåŠ¡å™¨å‚¨å­˜
    storageLocation = "workspace",
    
    init = function(self)
        print("ğŸ’¾ è®¾ç½®å‚¨å­˜ä½ç½®: " .. self.storageLocation)
    end,
    
    saveSettings = function(self)
        local success, result = pcall(function()
            -- æ ¹æ®é€‰æ‹©çš„å‚¨å­˜ä½ç½®ä¿å­˜è®¾ç½®
            if self.storageLocation == "player_data" then
                -- æ–¹æ³•1: ä¿å­˜åˆ°ç©å®¶æ•°æ®
                if _G.AimbotSettings then
                    _G.AimbotSettings = nil -- æ¸…é™¤æ—§æ•°æ®
                end
                _G.AimbotSettings = table.clone(Settings)
                
            elseif self.storageLocation == "workspace" then
                -- æ–¹æ³•2: ä¿å­˜åˆ°å·¥ä½œåŒº
                local storage = workspace:FindFirstChild("AimbotSettings")
                if storage then
                    storage:Destroy()
                end
                
                storage = Instance.new("Folder")
                storage.Name = "AimbotSettings"
                
                for key, value in pairs(Settings) do
                    local valueObj = Instance.new("StringValue")
                    valueObj.Name = key
                    valueObj.Value = tostring(value)
                    valueObj.Parent = storage
                end
                storage.Parent = workspace
                
            elseif self.storageLocation == "lighting" then
                -- æ–¹æ³•3: ä¿å­˜åˆ°å…‰ç…§
                local lighting = game:GetService("Lighting")
                local storage = lighting:FindFirstChild("AimbotSettings")
                if storage then
                    storage:Destroy()
                end
                
                storage = Instance.new("Folder")
                storage.Name = "AimbotSettings"
                
                for key, value in pairs(Settings) do
                    local valueObj = Instance.new("StringValue")
                    valueObj.Name = key
                    valueObj.Value = tostring(value)
                    valueObj.Parent = storage
                end
                storage.Parent = lighting
                
            elseif self.storageLocation == "replicated_storage" then
                -- æ–¹æ³•4: ä¿å­˜åˆ°å¤åˆ¶å‚¨å­˜
                local rs = game:GetService("ReplicatedStorage")
                local storage = rs:FindFirstChild("AimbotSettings")
                if storage then
                    storage:Destroy()
                end
                
                storage = Instance.new("Folder")
                storage.Name = "AimbotSettings"
                
                for key, value in pairs(Settings) do
                    local valueObj = Instance.new("StringValue")
                    valueObj.Name = key
                    valueObj.Value = tostring(value)
                    valueObj.Parent = storage
                end
                storage.Parent = rs
                
            elseif self.storageLocation == "server_storage" then
                -- æ–¹æ³•5: ä¿å­˜åˆ°æœåŠ¡å™¨å‚¨å­˜
                local ss = game:GetService("ServerStorage")
                local storage = ss:FindFirstChild("AimbotSettings")
                if storage then
                    storage:Destroy()
                end
                
                storage = Instance.new("Folder")
                storage.Name = "AimbotSettings"
                
                for key, value in pairs(Settings) do
                    local valueObj = Instance.new("StringValue")
                    valueObj.Name = key
                    valueObj.Value = tostring(value)
                    valueObj.Parent = storage
                end
                storage.Parent = ss
            end
            
            return true
        end)
        
        if success then
            print("âœ… è®¾ç½®ä¿å­˜æˆåŠŸ - ä½ç½®: " .. self.storageLocation)
        else
            print("âŒ è®¾ç½®ä¿å­˜å¤±è´¥: " .. tostring(result))
        end
    end,
    
    loadSettings = function(self)
        local success, result = pcall(function()
            if self.storageLocation == "player_data" then
                -- ä»ç©å®¶æ•°æ®åŠ è½½
                if _G.AimbotSettings then
                    for key, value in pairs(_G.AimbotSettings) do
                        if Settings[key] ~= nil then
                            -- ç±»å‹è½¬æ¢
                            if type(Settings[key]) == "boolean" then
                                Settings[key] = (value == true or value == "true")
                            elseif type(Settings[key]) == "number" then
                                Settings[key] = tonumber(value) or Settings[key]
                            else
                                Settings[key] = value
                            end
                        end
                    end
                end
                
            elseif self.storageLocation == "workspace" then
                -- ä»å·¥ä½œåŒºåŠ è½½
                local storage = workspace:FindFirstChild("AimbotSettings")
                if storage then
                    for _, valueObj in pairs(storage:GetChildren()) do
                        if Settings[valueObj.Name] ~= nil then
                            local value = valueObj.Value
                            if type(Settings[valueObj.Name]) == "boolean" then
                                Settings[valueObj.Name] = (value == "true")
                            elseif type(Settings[valueObj.Name]) == "number" then
                                Settings[valueObj.Name] = tonumber(value) or Settings[valueObj.Name]
                            else
                                Settings[valueObj.Name] = value
                            end
                        end
                    end
                end
                
            elseif self.storageLocation == "lighting" then
                -- ä»å…‰ç…§åŠ è½½
                local lighting = game:GetService("Lighting")
                local storage = lighting:FindFirstChild("AimbotSettings")
                if storage then
                    for _, valueObj in pairs(storage:GetChildren()) do
                        if Settings[valueObj.Name] ~= nil then
                            local value = valueObj.Value
                            if type(Settings[valueObj.Name]) == "boolean" then
                                Settings[valueObj.Name] = (value == "true")
                            elseif type(Settings[valueObj.Name]) == "number" then
                                Settings[valueObj.Name] = tonumber(value) or Settings[valueObj.Name]
                            else
                                Settings[valueObj.Name] = value
                            end
                        end
                    end
                end
                
            elseif self.storageLocation == "replicated_storage" then
                -- ä»å¤åˆ¶å‚¨å­˜åŠ è½½
                local rs = game:GetService("ReplicatedStorage")
                local storage = rs:FindFirstChild("AimbotSettings")
                if storage then
                    for _, valueObj in pairs(storage:GetChildren()) do
                        if Settings[valueObj.Name] ~= nil then
                            local value = valueObj.Value
                            if type(Settings[valueObj.Name]) == "boolean" then
                                Settings[valueObj.Name] = (value == "true")
                            elseif type(Settings[valueObj.Name]) == "number" then
                                Settings[valueObj.Name] = tonumber(value) or Settings[valueObj.Name]
                            else
                                Settings[valueObj.Name] = value
                            end
                        end
                    end
                end
                
            elseif self.storageLocation == "server_storage" then
                -- ä»æœåŠ¡å™¨å‚¨å­˜åŠ è½½
                local ss = game:GetService("ServerStorage")
                local storage = ss:FindFirstChild("AimbotSettings")
                if storage then
                    for _, valueObj in pairs(storage:GetChildren()) do
                        if Settings[valueObj.Name] ~= nil then
                            local value = valueObj.Value
                            if type(Settings[valueObj.Name]) == "boolean" then
                                Settings[valueObj.Name] = (value == "true")
                            elseif type(Settings[valueObj.Name]) == "number" then
                                Settings[valueObj.Name] = tonumber(value) or Settings[valueObj.Name]
                            else
                                Settings[valueObj.Name] = value
                            end
                        end
                    end
                end
            end
            
            return true
        end)
        
        if success then
            print("âœ… è®¾ç½®åŠ è½½æˆåŠŸ - ä½ç½®: " .. self.storageLocation)
        else
            print("âŒ è®¾ç½®åŠ è½½å¤±è´¥: " .. tostring(result))
        end
    end,
    
    autoSave = function(self)
        self:saveSettings()
    end
}

-- åˆå§‹åŒ–è®¾ç½®ç®¡ç†å™¨
SettingsManager:init()

-- æ£€æŸ¥ç‰©ä½“æ˜¯å¦å¯ç©¿é€
local function isPartPenetrable(part)
    if not part then return false end
    
    -- æ£€æŸ¥æè´¨
    local material = part.Material
    local penetrableMaterials = {
        Enum.Material.Plastic,
        Enum.Material.Glass,
        Enum.Material.Water,
        Enum.Material.Ice,
        Enum.Material.SmoothPlastic,
        Enum.Material.Neon,
        Enum.Material.ForceField
    }
    
    -- æ£€æŸ¥åç§°å…³é”®è¯
    local partName = part.Name:lower()
    local penetrableNames = {
        "glass", "window", "pane", "transparent", "see", "through",
        "forcefield", "shield", "barrier", "energy"
    }
    
    -- æ£€æŸ¥é€æ˜åº¦
    local isTransparent = part.Transparency > 0.5
    
    -- æ£€æŸ¥æ˜¯å¦å¯ç¢°æ’
    local isCollidable = part.CanCollide == false
    
    -- å¦‚æœæ˜¯ç»ç’ƒæè´¨ä¸”å¼€å¯ç»ç’ƒç©¿é€
    if Settings.penetrateGlass and material == Enum.Material.Glass then
        return true
    end
    
    -- æ£€æŸ¥æè´¨
    for _, penetrableMaterial in ipairs(penetrableMaterials) do
        if material == penetrableMaterial then
            return true
        end
    end
    
    -- æ£€æŸ¥åç§°
    for _, nameKeyword in ipairs(penetrableNames) do
        if string.find(partName, nameKeyword) then
            return true
        end
    end
    
    -- æ£€æŸ¥é€æ˜åº¦å’Œç¢°æ’
    if isTransparent or isCollidable then
        return true
    end
    
    return false
end

-- ç®€åŒ–çš„éš”å¢™æ£€æµ‹å‡½æ•°ï¼ˆæ”¯æŒç©¿é€ï¼‰
local function isTargetVisible(targetPosition, targetCharacter)
    if not Settings.wallCheckEnabled then
        return true
    end
    
    local cameraPosition = Camera.CFrame.Position
    local direction = (targetPosition - cameraPosition).Unit
    local distance = (targetPosition - cameraPosition).Magnitude
    
    -- ç®€åŒ–çš„å°„çº¿æ£€æµ‹
    local ray = Ray.new(cameraPosition, direction * distance)
    local hitPart, hitPosition = workspace:FindPartOnRayWithIgnoreList(ray, {LocalPlayer.Character}, false, true)
    
    -- å¦‚æœæ²¡æœ‰å‘½ä¸­ä»»ä½•ç‰©ä½“ï¼Œåˆ™è®¤ä¸ºå¯è§
    if not hitPart then
        return true
    end
    
    -- æ£€æŸ¥æ˜¯å¦å‘½ä¸­äº†ç›®æ ‡è§’è‰²
    if targetCharacter and hitPart:IsDescendantOf(targetCharacter) then
        return true
    end
    
    -- å¦‚æœå¼€å¯äº†ç©¿é€åŠŸèƒ½ï¼Œæ£€æŸ¥å‘½ä¸­çš„ç‰©ä½“æ˜¯å¦å¯ç©¿é€
    if Settings.penetrateWalls then
        if isPartPenetrable(hitPart) then
            return true  -- å¯ç©¿é€çš„ç‰©ä½“ï¼Œè®¤ä¸ºç›®æ ‡å¯è§
        end
    end
    
    return false  -- è¢«ä¸å¯ç©¿é€çš„ç‰©ä½“é®æŒ¡
end

-- è·å–æ‰€æœ‰æœ‰æ•ˆç›®æ ‡
local function getValidTargets()
    local targets = {}
    local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return targets end

    -- è·å–ç©å®¶ç›®æ ‡
    if Settings.targetPlayers then
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character then
                local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
                local head = player.Character:FindFirstChild("Head")
                
                if humanoid and humanoid.Health > 0 and head then
                    local distToPlayer = (hrp.Position - head.Position).Magnitude
                    -- ç§»é™¤è·ç¦»é™åˆ¶
                    table.insert(targets, {
                        object = head,
                        position = head.Position,
                        type = "player",
                        player = player,
                        character = player.Character,
                        distance = distToPlayer
                    })
                end
            end
        end
    end

    -- è·å–NPCç›®æ ‡
    if Settings.targetNPCs then
        for _, npc in pairs(workspace:GetDescendants()) do
            if npc:FindFirstChild("Humanoid") and npc:FindFirstChild("Head") then
                local humanoid = npc.Humanoid
                local head = npc.Head
                
                -- æ£€æŸ¥æ˜¯å¦æ˜¯NPCï¼ˆä¸æ˜¯ç©å®¶è§’è‰²ï¼‰
                local isPlayerCharacter = false
                for _, player in pairs(Players:GetPlayers()) do
                    if player.Character == npc then
                        isPlayerCharacter = true
                        break
                    end
                end
                
                if not isPlayerCharacter and humanoid.Health > 0 then
                    local distToNPC = (hrp.Position - head.Position).Magnitude
                    -- ç§»é™¤è·ç¦»é™åˆ¶
                    table.insert(targets, {
                        object = head,
                        position = head.Position,
                        type = "npc",
                        character = npc,
                        distance = distToNPC
                    })
                end
            end
        end
    end

    return targets
end

-- è·å–æœ€è¿‘ç›®æ ‡
local function getClosestTarget()
    local closest = nil
    local closestDist = math.huge
    local screenCenter = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
    
    local targets = getValidTargets()
    
    for _, target in ipairs(targets) do
        local screenPos, onScreen = Camera:WorldToViewportPoint(target.position)
        
        if onScreen then
            -- åº”ç”¨æœ€å¤§è·ç¦»è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
            if Settings.maxDistance > 0 and target.distance > Settings.maxDistance then
                continue
            end
            
            -- ç®€åŒ–çš„éš”å¢™æ£€æµ‹ï¼ˆæ”¯æŒç©¿é€ï¼‰
            local visible = isTargetVisible(target.position, target.character)
            
            if visible then
                local distToCenter = (screenCenter - Vector2.new(screenPos.X, screenPos.Y)).Magnitude
                if distToCenter <= Settings.fovRadius and distToCenter < closestDist then
                    closest = target
                    closestDist = distToCenter
                end
            end
        end
    end
    
    return closest
end

-- åˆ›å»ºå¸¦æ–‡æœ¬æ¡†çš„åˆ—è¡¨é¡¹
local function createListItemWithInput(parent, label, valueType, settingKey, options)
    local itemFrame = Instance.new("Frame")
    itemFrame.Size = UDim2.new(1, -20, 0, 60)
    itemFrame.Position = UDim2.new(0, 10, 0, 0)
    itemFrame.BackgroundTransparency = 1
    itemFrame.Parent = parent

    -- æ ‡ç­¾
    local labelText = Instance.new("TextLabel")
    labelText.Size = UDim2.new(0.6, -5, 0, 20)
    labelText.Position = UDim2.new(0, 0, 0, 0)
    labelText.BackgroundTransparency = 1
    labelText.Text = label
    labelText.TextColor3 = Color3.fromRGB(80, 80, 80)
    labelText.Font = Enum.Font.Gotham
    labelText.TextSize = 14
    labelText.TextXAlignment = Enum.TextXAlignment.Left
    labelText.Parent = itemFrame

    local controlFrame = Instance.new("Frame")
    controlFrame.Size = UDim2.new(0.4, 0, 1, 0)
    controlFrame.Position = UDim2.new(0.6, 5, 0, 0)
    controlFrame.BackgroundTransparency = 1
    controlFrame.Parent = itemFrame

    -- æ–‡æœ¬æ¡†
    local textBox = Instance.new("TextBox")
    textBox.Size = UDim2.new(1, 0, 0, 25)
    textBox.Position = UDim2.new(0, 0, 0, 30)
    textBox.BackgroundColor3 = Color3.fromRGB(240, 240, 240)
    textBox.TextColor3 = Color3.fromRGB(0, 0, 0)
    textBox.Font = Enum.Font.Gotham
    textBox.TextSize = 12
    textBox.Text = tostring(Settings[settingKey])
    textBox.PlaceholderText = "è¾“å…¥æ•°å€¼..."
    textBox.ClearTextOnFocus = false
    textBox.Parent = controlFrame

    local textBoxCorner = Instance.new("UICorner")
    textBoxCorner.CornerRadius = UDim.new(0, 4)
    textBoxCorner.Parent = textBox

    local textBoxStroke = Instance.new("UIStroke")
    textBoxStroke.Color = Color3.fromRGB(180, 180, 180)
    textBoxStroke.Thickness = 1
    textBoxStroke.Parent = textBox

    -- æ–‡æœ¬æ¡†è¾“å…¥å¤„ç†
    textBox.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            local value = tonumber(textBox.Text)
            if value then
                local minVal = options and options.min or 0
                local maxVal = options and options.max or 100
                
                if options and options.integer then
                    value = math.floor(value)
                end
                
                if value >= minVal and value <= maxVal then
                    Settings[settingKey] = value
                    textBox.Text = tostring(value)
                    SettingsManager:autoSave()
                else
                    textBox.Text = tostring(Settings[settingKey])
                end
            else
                textBox.Text = tostring(Settings[settingKey])
            end
        end
    end)

    if valueType == "toggle" then
        -- åˆ‡æ¢æŒ‰é’®
        local toggleBtn = Instance.new("TextButton")
        toggleBtn.Size = UDim2.new(1, 0, 0, 25)
        toggleBtn.Position = UDim2.new(0, 0, 0, 0)
        toggleBtn.BackgroundColor3 = Settings[settingKey] and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(200, 0, 0)
        toggleBtn.Text = Settings[settingKey] and "å¼€å¯" or "å…³é—­"
        toggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        toggleBtn.Font = Enum.Font.Gotham
        toggleBtn.TextSize = 12
        toggleBtn.Parent = controlFrame

        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 6)
        corner.Parent = toggleBtn

        toggleBtn.MouseButton1Click:Connect(function()
            Settings[settingKey] = not Settings[settingKey]
            toggleBtn.BackgroundColor3 = Settings[settingKey] and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(200, 0, 0)
            toggleBtn.Text = Settings[settingKey] and "å¼€å¯" or "å…³é—­"
            SettingsManager:autoSave()
        end)

    elseif valueType == "slider" then
        -- æ»‘å—
        local sliderContainer = Instance.new("Frame")
        sliderContainer.Size = UDim2.new(1, 0, 0, 25)
        sliderContainer.Position = UDim2.new(0, 0, 0, 0)
        sliderContainer.BackgroundTransparency = 1
        sliderContainer.Parent = controlFrame

        local sliderTrack = Instance.new("Frame")
        sliderTrack.Size = UDim2.new(1, 0, 0, 6)
        sliderTrack.Position = UDim2.new(0, 0, 0.5, -3)
        sliderTrack.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
        sliderTrack.Parent = sliderContainer

        local trackCorner = Instance.new("UICorner")
        trackCorner.CornerRadius = UDim.new(1, 0)
        trackCorner.Parent = sliderTrack

        local sliderFill = Instance.new("Frame")
        local minVal = options and options.min or 0
        local maxVal = options and options.max or 100
        local currentVal = math.clamp(Settings[settingKey], minVal, maxVal)
        local fillRatio = (currentVal - minVal) / (maxVal - minVal)
        
        sliderFill.Size = UDim2.new(fillRatio, 0, 1, 0)
        sliderFill.Position = UDim2.new(0, 0, 0, 0)
        sliderFill.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
        sliderFill.Parent = sliderTrack

        local fillCorner = Instance.new("UICorner")
        fillCorner.CornerRadius = UDim.new(1, 0)
        fillCorner.Parent = sliderFill

        local valueText = Instance.new("TextLabel")
        valueText.Size = UDim2.new(1, 0, 1, 0)
        valueText.BackgroundTransparency = 1
        valueText.Text = tostring(Settings[settingKey])
        valueText.TextColor3 = Color3.fromRGB(80, 80, 80)
        valueText.Font = Enum.Font.Gotham
        valueText.TextSize = 12
        valueText.Parent = sliderContainer

        -- æ›´æ–°æ»‘å—å‡½æ•°
        local function updateSlider(value)
            local minVal = options and options.min or 0
            local maxVal = options and options.max or 100
            local clampedValue = math.clamp(value, minVal, maxVal)
            local fillRatio = (clampedValue - minVal) / (maxVal - minVal)
            
            sliderFill.Size = UDim2.new(fillRatio, 0, 1, 0)
            valueText.Text = tostring(clampedValue)
            textBox.Text = tostring(clampedValue)
            Settings[settingKey] = clampedValue
        end

        -- æ»‘å—äº¤äº’
        local dragging = false
        
        local function handleSliderInput(input)
            local relativeX = (input.Position.X - sliderTrack.AbsolutePosition.X) / sliderTrack.AbsoluteSize.X
            relativeX = math.clamp(relativeX, 0, 1)
            
            local value = minVal + (relativeX * (maxVal - minVal))
            if options and options.integer then
                value = math.floor(value)
            else
                value = math.floor(value * 100) / 100
            end
            
            updateSlider(value)
        end

        sliderTrack.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                handleSliderInput(input)
            end
        end)

        sliderTrack.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
                SettingsManager:autoSave()
            end
        end)

        UserInputService.InputChanged:Connect(function(input)
            if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                handleSliderInput(input)
            end
        end)

        -- æ–‡æœ¬æ¡†åŒæ­¥æ»‘å—
        textBox.FocusLost:Connect(function(enterPressed)
            if enterPressed then
                local value = tonumber(textBox.Text)
                if value then
                    updateSlider(value)
                    SettingsManager:autoSave()
                else
                    textBox.Text = tostring(Settings[settingKey])
                end
            end
        end)

    elseif valueType == "dropdown" then
        -- ä¸‹æ‹‰é€‰æ‹©
        local dropdownBtn = Instance.new("TextButton")
        dropdownBtn.Size = UDim2.new(1, 0, 0, 25)
        dropdownBtn.Position = UDim2.new(0, 0, 0, 0)
        dropdownBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
        dropdownBtn.Text = options and options.options[Settings[settingKey]] or Settings[settingKey]
        dropdownBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        dropdownBtn.Font = Enum.Font.Gotham
        dropdownBtn.TextSize = 12
        dropdownBtn.Parent = controlFrame

        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 6)
        corner.Parent = dropdownBtn

        dropdownBtn.MouseButton1Click:Connect(function()
            if options and options.options then
                local currentIndex = 1
                for i, option in ipairs(options.options) do
                    if option == Settings[settingKey] then
                        currentIndex = i
                        break
                    end
                end
                
                local nextIndex = (currentIndex % #options.options) + 1
                Settings[settingKey] = options.options[nextIndex]
                dropdownBtn.Text = options.options[nextIndex]
                SettingsManager:autoSave()
            end
        end)
    end

    return itemFrame
end

-- åˆ›å»ºä¼˜åŒ–çš„åˆ—è¡¨å¼UI
local function createAimbotGUI()
    -- æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨GUIï¼Œé¿å…é‡å¤åˆ›å»º
    local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
    if playerGui and playerGui:FindFirstChild("PlayerAimbotUI") then
        return playerGui.PlayerAimbotUI
    end

    -- åˆ›å»ºScreenGui
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "PlayerAimbotUI"
    ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    ScreenGui.ResetOnSpawn = false  -- å…³é”®ï¼šé˜²æ­¢è§’è‰²é‡ç½®æ—¶é”€æ¯
    ScreenGui.IgnoreGuiInset = true

    -- ä¸­å¿ƒç»¿è‰²åœ†åœˆ
    Circle = Instance.new("Frame")
    Circle.Name = "AimCircle"
    Circle.AnchorPoint = Vector2.new(0.5, 0.5)
    Circle.Position = UDim2.new(0.5, 0, 0.5, 0)
    Circle.Size = UDim2.new(0, Settings.fovRadius * 2, 0, Settings.fovRadius * 2)
    Circle.BackgroundTransparency = 1
    Circle.Parent = ScreenGui

    local CircleStroke = Instance.new("UIStroke")
    CircleStroke.Parent = Circle
    CircleStroke.Color = Color3.fromRGB(0, 255, 0)
    CircleStroke.Thickness = 3
    CircleStroke.Transparency = 0

    local CircleCorner = Instance.new("UICorner")
    CircleCorner.Parent = Circle
    CircleCorner.CornerRadius = UDim.new(1, 0)

    -- ä¸»é¢æ¿
    mainPanel = Instance.new("Frame")
    mainPanel.Size = UDim2.new(0, 320, 0, 450) -- å¢åŠ é«˜åº¦ä»¥å®¹çº³æ–°è®¾ç½®
    mainPanel.Position = UDim2.new(0, 20, 0, 20)
    mainPanel.BackgroundColor3 = Color3.fromRGB(245, 245, 245)
    mainPanel.BorderSizePixel = 0
    mainPanel.Visible = Settings.uiVisible
    mainPanel.Parent = ScreenGui

    local panelCorner = Instance.new("UICorner", mainPanel)
    panelCorner.CornerRadius = UDim.new(0, 12)

    local panelShadow = Instance.new("UIStroke")
    panelShadow.Parent = mainPanel
    panelShadow.Color = Color3.fromRGB(0, 0, 0)
    panelShadow.Thickness = 1
    panelShadow.Transparency = 0.8

    -- æ ‡é¢˜æ 
    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, 0, 0, 30)
    titleBar.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    titleBar.Parent = mainPanel

    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 12)
    titleCorner.Parent = titleBar

    local titleText = Instance.new("TextLabel")
    titleText.Size = UDim2.new(0.8, 0, 1, 0)
    titleText.Position = UDim2.new(0, 10, 0, 0)
    titleText.BackgroundTransparency = 1
    titleText.Text = "æ™ºèƒ½è‡ªç„ç³»ç»Ÿ"
    titleText.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleText.Font = Enum.Font.GothamBold
    titleText.TextSize = 14
    titleText.TextXAlignment = Enum.TextXAlignment.Left
    titleText.Parent = titleBar

    -- çª—å£æ§åˆ¶æŒ‰é’®ï¼ˆåªä¿ç•™æœ€å°åŒ–æŒ‰é’®ï¼‰
    local controlsFrame = Instance.new("Frame")
    controlsFrame.Size = UDim2.new(0.2, 0, 1, 0)
    controlsFrame.Position = UDim2.new(0.8, 0, 0, 0)
    controlsFrame.BackgroundTransparency = 1
    controlsFrame.Parent = titleBar

    minimizeButton = Instance.new("TextButton")
    minimizeButton.Size = UDim2.new(0, 20, 0, 20)
    minimizeButton.Position = UDim2.new(0.5, -10, 0.5, -10)
    minimizeButton.BackgroundColor3 = Color3.fromRGB(255, 255, 0)
    minimizeButton.Text = "_"
    minimizeButton.TextColor3 = Color3.fromRGB(0, 0, 0)
    minimizeButton.Font = Enum.Font.GothamBold
    minimizeButton.TextSize = 14
    minimizeButton.Parent = controlsFrame

    local minCorner = Instance.new("UICorner")
    minCorner.CornerRadius = UDim.new(0, 4)
    minCorner.Parent = minimizeButton

    -- å†…å®¹åŒºåŸŸ
    local contentFrame = Instance.new("ScrollingFrame")
    contentFrame.Size = UDim2.new(1, 0, 1, -30)
    contentFrame.Position = UDim2.new(0, 0, 0, 30)
    contentFrame.BackgroundTransparency = 1
    contentFrame.BorderSizePixel = 0
    contentFrame.ScrollBarThickness = 4
    contentFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
    contentFrame.Parent = mainPanel

    local contentLayout = Instance.new("UIListLayout")
    contentLayout.Padding = UDim.new(0, 5)
    contentLayout.Parent = contentFrame

    -- åˆ›å»ºåˆ—è¡¨é¡¹ï¼ˆå¸¦æ–‡æœ¬æ¡†ï¼‰
    local yOffset = 10
    
    -- åŸºæœ¬è®¾ç½®
    createListItemWithInput(contentFrame, "è‡ªç„å¼€å…³", "toggle", "aimbotEnabled")
    createListItemWithInput(contentFrame, "éš”å¢™æ£€æµ‹", "toggle", "wallCheckEnabled")
    createListItemWithInput(contentFrame, "å³é”®è‡ªç„", "toggle", "rightClickEnabled")
    createListItemWithInput(contentFrame, "å¹³æ»‘è‡ªç„", "toggle", "smoothAiming")
    createListItemWithInput(contentFrame, "é”å®šç©å®¶", "toggle", "targetPlayers")
    createListItemWithInput(contentFrame, "é”å®šNPC", "toggle", "targetNPCs")
    
    -- æ–°å¢ï¼šç©¿é€è®¾ç½®
    createListItemWithInput(contentFrame, "ç©¿é€å¢™å£", "toggle", "penetrateWalls")
    createListItemWithInput(contentFrame, "ç©¿é€ç»ç’ƒ", "toggle", "penetrateGlass")
    
    -- æ¨¡å¼é€‰æ‹©
    createListItemWithInput(contentFrame, "å³é”®æ¨¡å¼", "dropdown", "rightClickMode", {
        options = {"hold", "toggle", "hybrid"}
    })
    
    -- å‚æ•°è®¾ç½®ï¼ˆæ— é™åˆ¶ + æ–‡æœ¬æ¡†ï¼‰
    createListItemWithInput(contentFrame, "è‡ªç„é€Ÿåº¦", "slider", "aimSpeed", {
        min = 1, max = 100, integer = true
    })
    
    createListItemWithInput(contentFrame, "è‡ªç„åŠ›åº¦", "slider", "aimStrength", {
        min = 0.1, max = 10.0, integer = false
    })
    
    createListItemWithInput(contentFrame, "åœ†åœˆå¤§å°", "slider", "fovRadius", {
        min = 10, max = 1000, integer = true
    })
    
    createListItemWithInput(contentFrame, "æœ€å¤§è·ç¦»", "slider", "maxDistance", {
        min = 0, max = 5000, integer = true  -- 0è¡¨ç¤ºæ— é™åˆ¶
    })

    -- çª—å£æ§åˆ¶åŠŸèƒ½ï¼ˆåªä¿ç•™æœ€å°åŒ–ï¼‰
    minimizeButton.MouseButton1Click:Connect(function()
        Settings.uiMinimized = not Settings.uiMinimized
        if Settings.uiMinimized then
            mainPanel.Size = UDim2.new(0, 320, 0, 30)
            contentFrame.Visible = false
        else
            mainPanel.Size = UDim2.new(0, 320, 0, 450)
            contentFrame.Visible = true
        end
        SettingsManager:autoSave()
    end)

    -- æ‹–æ‹½åŠŸèƒ½
    local dragging, dragInput, dragStart, startPos
    local function update(input)
        local delta = input.Position - dragStart
        local newPosition = UDim2.new(
            startPos.X.Scale, 
            startPos.X.Offset + delta.X,
            startPos.Y.Scale, 
            startPos.Y.Offset + delta.Y
        )
        mainPanel.Position = newPosition
    end
    
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = mainPanel.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    titleBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)

    return ScreenGui
end

-- å¹³æ»‘è‡ªç„å‡½æ•°
local function smoothAim(targetPosition)
    if not Settings.smoothAiming then
        Camera.CFrame = CFrame.new(Camera.CFrame.Position, targetPosition)
        return
    end
    
    local currentLook = Camera.CFrame.LookVector
    local targetDirection = (targetPosition - Camera.CFrame.Position).Unit
    
    local dotProduct = currentLook:Dot(targetDirection)
    local angle = math.acos(math.clamp(dotProduct, -1, 1))
    
    local maxAngle = math.rad(180)
    local speedFactor = Settings.aimSpeed / 30
    local lerpAlpha = math.min(angle / maxAngle * speedFactor * Settings.aimStrength, 1.0)
    
    local newLook = currentLook:Lerp(targetDirection, lerpAlpha).Unit
    Camera.CFrame = CFrame.new(Camera.CFrame.Position, Camera.CFrame.Position + newLook)
end

-- åˆå§‹åŒ–ç³»ç»Ÿ
local function initializeSystem()
    SettingsManager:loadSettings()
    
    -- æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨GUI
    local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
    if playerGui and playerGui:FindFirstChild("PlayerAimbotUI") then
        aimbotGUI = playerGui.PlayerAimbotUI
        print("ğŸ” æ£€æµ‹åˆ°ç°æœ‰GUIï¼Œæ— éœ€é‡æ–°åˆ›å»º")
    else
        aimbotGUI = createAimbotGUI()
        print("âœ… åˆ›å»ºæ–°çš„è‡ªç„GUI")
    end
    
    print("ğŸ¯ æ™ºèƒ½è‡ªç„ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")
    print("ğŸ“Š å½“å‰è®¾ç½®:")
    print("   â€¢ è‡ªç„: " .. (Settings.aimbotEnabled and "å¼€å¯" or "å…³é—­"))
    print("   â€¢ éš”å¢™æ£€æµ‹: " .. (Settings.wallCheckEnabled and "å¼€å¯" or "å…³é—­"))
    print("   â€¢ å³é”®è‡ªç„: " .. (Settings.rightClickEnabled and "å¼€å¯" or "å…³é—­"))
    print("   â€¢ ç©¿é€å¢™å£: " .. (Settings.penetrateWalls and "å¼€å¯" or "å…³é—­"))
    print("   â€¢ ç©¿é€ç»ç’ƒ: " .. (Settings.penetrateGlass and "å¼€å¯" or "å…³é—­"))
    print("   â€¢ å³é”®æ¨¡å¼: " .. Settings.rightClickMode)
    print("   â€¢ é”å®šç©å®¶: " .. (Settings.targetPlayers and "å¼€å¯" or "å…³é—­"))
    print("   â€¢ é”å®šNPC: " .. (Settings.targetNPCs and "å¼€å¯" or "å…³é—­"))
    print("ğŸ’¾ è®¾ç½®å‚¨å­˜ä½ç½®: " .. SettingsManager.storageLocation)
end

-- æ™ºèƒ½å³é”®è‡ªç„æ§åˆ¶
UserInputService.InputBegan:Connect(function(input, processed)
    if not Settings.rightClickEnabled then return end
    
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        local currentTime = tick()
        
        -- å†·å´æ—¶é—´æ£€æŸ¥
        if currentTime - lastRightClickTime < rightClickCooldown then
            return
        end
        lastRightClickTime = currentTime
        
        if Settings.rightClickMode == "hold" then
            -- æŒ‰ä½æ¨¡å¼ï¼šç«‹å³å¼€å¯è‡ªç„
            rightClickAimbot = true
        elseif Settings.rightClickMode == "toggle" then
            -- åˆ‡æ¢æ¨¡å¼ï¼šç‚¹å‡»åˆ‡æ¢çŠ¶æ€
            rightClickToggled = not rightClickToggled
            rightClickAimbot = rightClickToggled
        else
            -- æ··åˆæ¨¡å¼ï¼šçŸ­æŒ‰åˆ‡æ¢ï¼Œé•¿æŒ‰ä¿æŒ
            rightClickAimbot = true
            rightClickToggled = false
        end
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        if Settings.rightClickMode == "hold" then
            -- æŒ‰ä½æ¨¡å¼ï¼šé‡Šæ”¾æ—¶å…³é—­
            rightClickAimbot = false
        elseif Settings.rightClickMode == "hybrid" then
            -- æ··åˆæ¨¡å¼ï¼šå¦‚æœä¸æ˜¯åˆ‡æ¢çŠ¶æ€ï¼Œé‡Šæ”¾æ—¶å…³é—­
            if not rightClickToggled then
                rightClickAimbot = false
            end
        end
        -- åˆ‡æ¢æ¨¡å¼ä¿æŒçŠ¶æ€ä¸å˜
    end
end)

-- ä¸»è‡ªç„å¾ªç¯
RunService.RenderStepped:Connect(function()
    -- æ›´æ–°åœ†åœˆå¤§å°
    if Circle then
        Circle.Size = UDim2.new(0, Settings.fovRadius * 2, 0, Settings.fovRadius * 2)
    end
    
    local shouldAim = Settings.aimbotEnabled or (Settings.rightClickEnabled and rightClickAimbot)
    
    if shouldAim then
        local target = getClosestTarget()
        if target then
            currentTarget = target
            smoothAim(target.position)
            lastAimTime = tick()
        elseif currentTarget and Settings.smoothAiming then
            if tick() - lastAimTime < 0.5 then
                smoothAim(currentTarget.position)
            else
                currentTarget = nil
            end
        end
    else
        currentTarget = nil
        if Settings.rightClickMode == "toggle" then
            rightClickToggled = false
            rightClickAimbot = false
        end
    end
end)

-- è‡ªåŠ¨ä¿å­˜ç³»ç»Ÿ
spawn(function()
    while true do
        wait(30)
        SettingsManager:autoSave()
    end
end)

-- å¯åŠ¨ç³»ç»Ÿ
initializeSystem()

print("ğŸš€ æ™ºèƒ½è‡ªç„ç³»ç»ŸåŠ è½½å®Œæˆï¼")
print("ğŸ“ å³é”®è‡ªç„æ¨¡å¼è¯´æ˜:")
print("   â€¢ æŒ‰ä½æ¨¡å¼: æŒ‰ä½å³é”®æ—¶è‡ªç„ï¼Œé‡Šæ”¾æ—¶åœæ­¢")
print("   â€¢ åˆ‡æ¢æ¨¡å¼: ç‚¹å‡»å³é”®åˆ‡æ¢è‡ªç„çŠ¶æ€")
print("   â€¢ æ··åˆæ¨¡å¼: çŸ­æŒ‰åˆ‡æ¢ï¼Œé•¿æŒ‰ä¿æŒ")
print("ğŸ¯ ç©¿é€åŠŸèƒ½è¯´æ˜:")
print("   â€¢ ç©¿é€å¢™å£: å¯ç©¿é€å¡‘æ–™ã€åŠ›åœºç­‰æè´¨")
print("   â€¢ ç©¿é€ç»ç’ƒ: ä¸“é—¨ç©¿é€ç»ç’ƒæè´¨")
print("   â€¢ å¯ç©¿é€ç‰©ä½“: ç»ç’ƒã€å¡‘æ–™ã€åŠ›åœºã€æ°´ã€å†°ç­‰")
print("ğŸ’¡ æ¨èè®¾ç½®:")
print("   â€¢ å¼€å¯'ç©¿é€ç»ç’ƒ'æé«˜å®ç”¨æ€§")
print("   â€¢ æ ¹æ®æ¸¸æˆéœ€æ±‚é€‰æ‹©æ˜¯å¦å¼€å¯'ç©¿é€å¢™å£'")
print("ğŸ›¡ï¸ ç³»ç»Ÿå·²é˜²é‡ç½®ï¼Œè§’è‰²æ­»äº¡ä¸ä¼šå½±å“è„šæœ¬è¿è¡Œ")
print("ğŸ’¾ è®¾ç½®å‚¨å­˜ä½ç½®: " .. SettingsManager.storageLocation)